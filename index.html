<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AI Chat Interface with voice recognition">
  <title>AI Chat Interface</title>
  <style>
    :root {
      --primary-color: #2ea6ff;
      --background-color: #000000;
      --text-color: #ffffff;
      --message-bg: rgba(45, 45, 45, 0.5);
      --input-bg: rgba(255, 255, 255, 0.1);
      --recording-color: #ff4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    html, body {
      overflow-x: hidden;
    }

    body {
      background: var(--background-color);
      color: var(--text-color);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Snowflake animation */
    .snowflake {
      position: fixed;
      width: 4px;
      height: 4px;
      background: var(--text-color);
      border-radius: 50%;
      pointer-events: none;
      filter: blur(1px);
      animation: fall linear infinite;
      z-index: 1;
      box-shadow: 0 0 5px var(--text-color);
      opacity: 0.6;
      will-change: transform;
    }

    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
      }
    }

    /* Robot animation */
    .robot {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 60px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: float 3s ease-in-out infinite;
      box-shadow: 0 0 30px var(--primary-color);
      will-change: transform;
    }

    .robot svg {
      width: 40px;
      height: 40px;
      fill: var(--text-color);
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
    }

    @keyframes float {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-10px); }
    }

    /* Chat container */
    .chat-container {
      padding: 80px 20px 100px;
      height: 100vh;
      overflow-y: auto;
      position: relative;
      z-index: 2;
      scroll-behavior: smooth;
      
      /* Hide scrollbar for Chrome, Safari and Opera */
      &::-webkit-scrollbar {
        display: none;
      }
      
      /* Hide scrollbar for IE, Edge and Firefox */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .messages-wrapper {
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .message {
      margin: 10px 0;
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 80%;
      animation: fadeIn 0.3s ease-in-out;
      position: relative;
      line-height: 1.5;
      word-wrap: break-word;
      background: var(--message-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .user-message {
      background: rgba(46, 166, 255, 0.8);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .bot-message {
      background: var(--message-bg);
      margin-right: auto;
      border-bottom-left-radius: 4px;
      padding-left: 45px;
    }

    .message-icon {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message-icon svg {
      width: 24px;
      height: 24px;
      fill: var(--primary-color);
      filter: drop-shadow(0 0 3px var(--primary-color));
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Input area */
    .input-container {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      gap: 12px;
      z-index: 1000;
      width: 100%;
      max-width: 800px;
    }

    .input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      gap: 12px;
    }

    .pae-button {
      position: absolute;
      left: 23px;
      bottom: calc(100% + 8px);
      height: 32px;
      padding: 0 16px;
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      color: var(--text-color);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 15px rgba(46, 166, 255, 0.5);
      z-index: 2;
    }

    .pae-button:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }

    .pae-button:active {
      transform: scale(0.95);
    }

    .pae-button.active {
      background: var(--recording-color);
      box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
    }

    .input-field {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
    }

    .input-field:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .input-field.recording {
      background: rgba(255, 68, 68, 0.1);
      animation: recordingPulse 1.5s ease-in-out infinite;
    }

    @keyframes recordingPulse {
      0% { background: rgba(255, 68, 68, 0.1); }
      50% { background: rgba(255, 68, 68, 0.2); }
      100% { background: rgba(255, 68, 68, 0.1); }
    }

    .buttons-container {
      display: flex;
      gap: 8px;
    }

    .send-button,
    .mic-button {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      box-shadow: 0 0 15px var(--primary-color);
    }

    .send-button:hover,
    .mic-button:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
    }

    .send-button:active,
    .mic-button:active {
      transform: scale(0.95);
    }

    .send-button svg,
    .mic-button svg {
      width: 24px;
      height: 24px;
      fill: var(--text-color);
    }

    .send-button svg {
      transform: rotate(45deg);
    }

    .mic-button.recording {
      background: var(--recording-color);
      box-shadow: 0 0 15px var(--recording-color);
    }

    @media (max-width: 600px) {
      .message {
        max-width: 90%;
      }
      
      .input-container {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // OpenAI Configuration
    let useOpenAI = false;
    let openAIKey = null;

    // Interface Elements
    let chatContainer;
    let messagesWrapper;
    let inputField;
    let sendButton;
    let micButton;
    let paeButton;
    let isRecording = false;
    let isTyping = false;
    let shouldAutoScroll = true;

    // Функция переключения режима OpenAI
    async function toggleOpenAI() {
      if (!useOpenAI) {
        const key = prompt("Пожалуйста, введите ваш ключ PaeAPI:");
        if (key) {
          openAIKey = key;
          useOpenAI = true;
          paeButton.classList.add('active');
          return "Режим Pae+ включен. Теперь я буду использовать Pae+AI для ответов.";
        } else {
          return "Ключ API не был предоставлен. Продолжаю работу в обычном режиме.";
        }
      } else {
        useOpenAI = false;
        openAIKey = null;
        paeButton.classList.remove('active');
        return "Режим Pae+ выключен. Возвращаюсь к использованию локальной базы данных.";
      }
    }

    // Функция для получения ответа от OpenAI
    async function getOpenAIResponse(text) {
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${openAIKey}`
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [{
              role: "user",
              content: text
            }],
            temperature: 0.7
          })
        });

        if (!response.ok) {
          throw new Error('OpenAI API error');
        }

        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error('OpenAI API error:', error);
        throw error;
      }
    }

    // Message Processing
    async function processMessage(text) {
      if (useOpenAI) {
        try {
          return await getOpenAIResponse(text);
        } catch (error) {
          console.error('OpenAI error:', error);
          return "Извините, произошла ошибка при обработке запроса. Попробуйте позже или переключитесь в обычный режим.";
        }
      }

      try {
        if (typeof findBestMatch !== 'function') {
          throw new Error('База данных не загружена');
        }
        const result = findBestMatch(text);
        return result.response;
      } catch (error) {
        console.error('Ошибка обработки сообщения:', error);
        return "Извините, произошла ошибка при обработке сообщения. Пожалуйста, попробуйте позже.";
      }
    }

    // Interface Creation
    function createInterface() {
      const root = document.getElementById('root');
      if (!root) return;

      // Robot
      const robot = document.createElement('div');
      robot.className = 'robot';
      robot.innerHTML = `
        <svg viewBox="0 0 24 24">
          <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A2.5,2.5 0 0,0 5,15.5A2.5,2.5 0 0,0 7.5,18A2.5,2.5 0 0,0 10,15.5A2.5,2.5 0 0,0 7.5,13M16.5,13A2.5,2.5 0 0,0 14,15.5A2.5,2.5 0 0,0 16.5,18A2.5,2.5 0 0,0 19,15.5A2.5,2.5 0 0,0 16.5,13Z"/>
        </svg>
      `;

      // Chat Container
      chatContainer = document.createElement('div');
      chatContainer.className = 'chat-container';
      chatContainer.addEventListener('scroll', handleScroll);

      messagesWrapper = document.createElement('div');
      messagesWrapper.className = 'messages-wrapper';
      chatContainer.appendChild(messagesWrapper);

      // Input Container
      const inputContainer = document.createElement('div');
      inputContainer.className = 'input-container';

      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'input-wrapper';

      // PAE Button
      paeButton = document.createElement('button');
      paeButton.className = 'pae-button';
      paeButton.textContent = 'Pae+';
      paeButton.addEventListener('click', async () => {
        const response = await toggleOpenAI();
        addMessage(response, false);
      });
      inputWrapper.appendChild(paeButton);

      // Input Field
      inputField = document.createElement('input');
      inputField.type = 'text';
      inputField.className = 'input-field';
      inputField.placeholder = 'Введите ваш вопрос...';
      inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      });
      inputField.addEventListener('input', () => {
        paeButton.style.display = inputField.value ? 'none' : 'flex';
      });

      // Buttons Container
      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'buttons-container';

      // Mic Button
      micButton = document.createElement('button');
      micButton.className = 'mic-button';
      micButton.innerHTML = `
        <svg viewBox="0 0 24 24">
          <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
        </svg>
      `;
      micButton.addEventListener('click', handleVoiceInput);

      // Send Button
      sendButton = document.createElement('button');
      sendButton.className = 'send-button';
      sendButton.innerHTML = `
        <svg viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      `;
      sendButton.addEventListener('click', handleSendMessage);

      // Assemble Interface
      buttonsContainer.appendChild(micButton);
      buttonsContainer.appendChild(sendButton);
      inputWrapper.appendChild(inputField);
      inputWrapper.appendChild(buttonsContainer);
      inputContainer.appendChild(inputWrapper);

      root.appendChild(robot);
      root.appendChild(chatContainer);
      root.appendChild(inputContainer);
    }

    function initializeSnowflakes() {
      const MAX_SNOWFLAKES = 15;
      let snowflakeCount = 0;

      function createSnowflake() {
        if (snowflakeCount >= MAX_SNOWFLAKES) return;

        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.style.left = `${Math.random() * 100}vw`;
        snowflake.style.animationDuration = `${Math.random() * 5 + 3}s`;
        snowflake.style.opacity = `${Math.random() * 0.2 + 0.1}`;
        document.body.appendChild(snowflake);

        snowflake.style.top = '-10px';
        snowflakeCount++;

        snowflake.addEventListener('animationend', () => {
          snowflake.remove();
          snowflakeCount--;
        });
      }

      setInterval(createSnowflake, 800);
    }

    function showWelcomeMessage() {
      setTimeout(() => {
        addMessage("Привет! Задайте мне вопрос голосом или текстом, и я постараюсь на него ответить.", false);
      }, 500);
    }

    function handleScroll() {
      if (!chatContainer) return;
      const { scrollTop, scrollHeight, clientHeight } = chatContainer;
      shouldAutoScroll = Math.abs(scrollHeight - clientHeight - scrollTop) < 50;
    }

    async function addMessage(text, isUser) {
      const message = document.createElement('div');
      message.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

      if (!isUser) {
        const icon = document.createElement('div');
        icon.className = 'message-icon';
        icon.innerHTML = `
          <svg viewBox="0 0 24 24">
            <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A2.5,2.5 0 0,0 5,15.5A2.5,2.5 0 0,0 7.5,18A2.5,2.5 0 0,0 10,15.5A2.5,2.5 0 0,0 7.5,13M16.5,13A2.5,2.5 0 0,0 14,15.5A2.5,2.5 0 0,0 16.5,18A2.5,2.5 0 0,0 19,15.5A2.5,2.5 0 0,0 16.5,13Z"/>
          </svg>
        `;
        message.appendChild(icon);
      }

      const content = document.createElement('span');
      message.appendChild(content);
      messagesWrapper.appendChild(message);

      if (!isUser) {
        isTyping = true;
        content.textContent = '';
        let displayedText = '';

        for (let i = 0; i < text.length; i++) {
          if (!isTyping) break;
          displayedText += text[i];
          content.textContent = displayedText;
          await new Promise(resolve => setTimeout(resolve, 20));

          if (shouldAutoScroll) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        }

        isTyping = false;
      } else {
        content.textContent = text;
      }

      if (shouldAutoScroll) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    async function handleSendMessage() {
      const text = inputField.value.trim();
      if (!text || isTyping) return;

      inputField.value = '';
      paeButton.style.display = 'flex';

      await addMessage(text, true);

      try {
        const response = await processMessage(text);
        await addMessage(response, false);
      } catch (error) {
        console.error('Error processing message:', error);
        await addMessage("Извините, произошла ошибка при обработке сообщения.", false);
      }
    }

    function handleVoiceInput() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('К сожалению, ваш браузер не поддерживает распознавание речи.');
        return;
      }

      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.continuous = false;
      recognition.interimResults = true;

      recognition.onstart = () => {
        isRecording = true;
        micButton.classList.add('recording');
        inputField.classList.add('recording');
        inputField.placeholder = 'Говорите...';
        inputField.disabled = true;
      };

      recognition.onend = () => {
        isRecording = false;
        micButton.classList.remove('recording');
        inputField.classList.remove('recording');
        inputField.disabled = false;
        inputField.placeholder = 'Введите ваш вопрос...';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        inputField.value = transcript;
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isRecording = false;
        micButton.classList.remove('recording');
        inputField.classList.remove('recording');
        inputField.disabled = false;
        inputField.value = '';
        inputField.placeholder = 'Введите ваш вопрос...';
        alert('Ошибка распознавания речи. Пожалуйста, попробуйте еще раз.');
      };

      recognition.start();
    }

    // Initialize App
    document.addEventListener('DOMContentLoaded', () => {
      createInterface();
      initializeSnowflakes();
      showWelcomeMessage();
    });
  </script>
</body>
</html>
